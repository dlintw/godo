#!/usr/bin/env sh

function usage () {
	local name=`basename $0`
	echo "usage: $name <go-source-file> ..."
	exit 1
}

if test -z "$*"; then
	usage
fi

for file in "$@"; do
	if ! test -f "$file"; then
		echo "file not found: $file"
		usage
	fi
done

TMP_GODO_DIR="$TMPDIR/$$.$RANDOM"
if ! mkdir "$TMP_GODO_DIR"; then
	echo "could not create temporary directory... sigh"
	exit 1
fi

SRCDIR="$TMP_GODO_DIR/src"
mkdir "$SRCDIR"

for file in "$@"; do
	DESTFILE="$SRCDIR/$file"
	if test "#!" = `head -n1 "$file" | cut -c 1-2 `; then
		sed -n '2,$p' $file > $DESTFILE
	else
		cp "$file" $DESTFILE
	fi
done

cat > $TMP_GODO_DIR/Makefile <<EOF
include \$(GOROOT)/src/Make.inc
TARG=tmp.out
GOFILES=$SRCDIR/*
include \$(GOROOT)/src/Make.cmd
EOF

make --silent --directory=$TMP_GODO_DIR && $TMP_GODO_DIR/tmp.out
rm -rf $TMP_GODO_DIR