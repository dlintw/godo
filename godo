#!/usr/bin/env bash

function usage {
	local name=${0##*/}
	echo "usage: $name <go-source-file> ..."
	exit 1
}

FILES=()
ARGS=()
DONE_WITH_FILES=false

for arg in "$@"; do
	if [[ "$arg" == "--" ]]; then
		DONE_WITH_FILES=true
		continue
	fi
	
	if $DONE_WITH_FILES; then
		ARGS[${#ARGS[*]}]="$arg"
	else
		if ! [[ -f "$arg" ]]; then
			echo "file not found: $arg"
			usage
		fi
		FILES[${#FILES[*]}]="$arg"
	fi
done

TMPDIR=$(mktemp -d -t "godo.$RANDOM.$$")

if [[ $? != 0 ]]; then
	echo "could not create temporary directory... sigh"
	exit 1
fi

SRCDIR="$TMPDIR/src"
mkdir "$SRCDIR"

if (( ${#FILES[*]} == 0 )); then
	TMPFILE="$TMPDIR/tmp.go"
	cat > "$TMPFILE"
	FILES[${#FILES[*]}]="$TMPFILE"
fi

for file in "${FILES[@]}"; do
	DESTFILE="$SRCDIR/$(basename $file)"
	awk 'NR==1 && /^#!/ { next } { print }' "$file" > "$DESTFILE"
done

cat > $TMPDIR/Makefile <<EOF
include \$(GOROOT)/src/Make.inc
TARG=tmp.out
GOFILES=$SRCDIR/*
include \$(GOROOT)/src/Make.cmd
EOF

make --silent --directory="$TMPDIR" && "$TMPDIR/tmp.out" "${ARGS[@]}"
rm -rf "$TMPDIR"